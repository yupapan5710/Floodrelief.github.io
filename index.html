<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ศูนย์กลางแจ้งขอความช่วยเหลือ น้ำท่วมภาคใต้</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
  />
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container-fluid">
      <span class="navbar-brand">
        ศูนย์แจ้งขอความช่วยเหลือ น้ำท่วมภาคใต้
      </span>
    </div>
  </nav>

  <div class="container mb-5">
    <div class="row">

      <!-- ฟอร์มแจ้งขอความช่วยเหลือ -->
      <div class="col-lg-5 mb-4">
        <div class="card shadow-sm">
          <div class="card-header bg-danger text-white">
            แจ้งขอความช่วยเหลือ
          </div>
          <div class="card-body">
            <form id="helpForm">
              <div class="mb-2">
                <label class="form-label">ชื่อผู้แจ้ง</label>
                <input type="text" class="form-control" id="reporterName" required />
              </div>

              <div class="mb-2">
                <label class="form-label">เบอร์ติดต่อกลับ</label>
                <input type="tel" class="form-control" id="phone" required />
              </div>

              <div class="mb-2">
                <label class="form-label">จังหวัด / อำเภอ / ตำบล</label>
                <input type="text" class="form-control" id="area" required />
              </div>

              <div class="mb-2">
                <label class="form-label">รายละเอียดที่อยู่ / พิกัดบ้าน</label>
                <textarea class="form-control" id="address" rows="2" required></textarea>
              </div>

              <div class="mb-2">
                <label class="form-label">ลิงก์พิกัดแผนที่ (Google Maps)</label>
                <input type="text" class="form-control" id="locationLink" />
              </div>

              <hr />

              <!-- จำนวนคนในบ้าน -->
              <div class="mb-2">
                <label class="form-label">จำนวนคนในบ้าน</label>
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label small">เด็ก</label>
                    <input type="number" min="0" value="0" class="form-control" id="children" />
                  </div>
                  <div class="col-6">
                    <label class="form-label small">ผู้ใหญ่</label>
                    <input type="number" min="0" value="0" class="form-control" id="adults" />
                  </div>
                  <div class="col-6">
                    <label class="form-label small">ผู้สูงอายุ</label>
                    <input type="number" min="0" value="0" class="form-control" id="elderly" />
                  </div>
                  <div class="col-6">
                    <label class="form-label small">ผู้ป่วย / ผู้พิการ</label>
                    <input type="number" min="0" value="0" class="form-control" id="patients" />
                  </div>
                  <div class="col-6">
                    <label class="form-label small">สัตว์เลี้ยง</label>
                    <input type="number" min="0" value="0" class="form-control" id="pets" />
                  </div>
                </div>
              </div>

              <div class="mb-2">
                <label class="form-label">ระดับน้ำท่วม</label>
                <select class="form-select" id="waterLevel">
                  <option value="ไม่ทราบ">ไม่ทราบ / ไม่ระบุ</option>
                  <option value="ระดับเข่า">ระดับเข่า</option>
                  <option value="ระดับเอว">ระดับเอว</option>
                  <option value="ระดับอก">ระดับอก</option>
                  <option value="สูงกว่าหน้าต่าง">สูงกว่าหน้าต่าง</option>
                </select>
              </div>

              <!-- ความช่วยเหลือที่ต้องการ -->
              <div class="mb-2">
                <label class="form-label">ความช่วยเหลือที่ต้องการ (เลือกได้หลายข้อ)</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="needFood">
                  <label class="form-check-label" for="needFood">อาหารแห้ง/อาหารพร้อมทาน</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="needWater">
                  <label class="form-check-label" for="needWater">น้ำดื่ม</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="needMedicine">
                  <label class="form-check-label" for="needMedicine">ยาและเวชภัณฑ์</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="needBoat">
                  <label class="form-check-label" for="needBoat">เรือ / พาหนะช่วยเหลือ</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="needEvac">
                  <label class="form-check-label" for="needEvac">อพยพออกจากพื้นที่</label>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">รายละเอียดเพิ่มเติม</label>
                <textarea class="form-control" id="detail" rows="2"></textarea>
              </div>

              <button type="submit" class="btn btn-danger w-100">
                ส่งคำขอความช่วยเหลือ
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- ฝั่งขวา: สรุป + รายการคำขอ -->
      <div class="col-lg-7 mb-4">
        <div class="card shadow-sm mb-3">
          <div class="card-header bg-info text-white">
            สรุปภาพรวมการขอความช่วยเหลือ
          </div>
          <div class="card-body" id="summary">
            <p class="text-muted mb-0">กำลังโหลดข้อมูลสรุป...</p>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <span>รายการขอความช่วยเหลือ</span>
            <select id="statusFilter" class="form-select form-select-sm" style="width:auto;">
              <option value="all">แสดงทั้งหมด</option>
              <option value="pending">รอความช่วยเหลือ</option>
              <option value="helping">กำลังให้ความช่วยเหลือ</option>
              <option value="done">ได้รับความช่วยเหลือแล้ว</option>
            </select>
          </div>
          <div class="card-body">
            <div id="requestsList" class="small"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBB7AlpPEAN2eAtT2u2ARmdUA447MliS1E",
      authDomain: "thai-flood-relief.firebaseapp.com",
      projectId: "thai-flood-relief",
      storageBucket: "thai-flood-relief.firebasestorage.app",
      messagingSenderId: "1037111083170",
      appId: "1:1037111083170:web:f7a06ba01e8ab916bcd7fb"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    let requestsCache = [];

    function getMyHelperPhone() {
      return localStorage.getItem("myHelperPhone") || "";
    }

    function renderSummary() {
      const summaryEl = document.getElementById("summary");
      if (!summaryEl) return;

      if (requestsCache.length === 0) {
        summaryEl.innerHTML = "<p class='text-muted mb-0'>ยังไม่มีข้อมูลสรุป</p>";
        return;
      }

      const today = new Date();
      const todayStr = today.toISOString().slice(0, 10);

      let total = requestsCache.length;
      let pending = 0, helping = 0, done = 0;
      let todayTotal = 0, todayPending = 0, todayDone = 0;

      const byDate = {};

      requestsCache.forEach(r => {
        if (r.status === "รอความช่วยเหลือ") pending++;
        else if (r.status === "มีอาสาช่วยแล้ว") helping++;
        else if (r.status === "ได้รับความช่วยเหลือแล้ว") done++;

        if (r.createdAtDate === todayStr) {
          todayTotal++;
          if (r.status === "รอความช่วยเหลือ" || r.status === "มีอาสาช่วยแล้ว") todayPending++;
          if (r.status === "ได้รับความช่วยเหลือแล้ว") todayDone++;
        }

        if (r.createdAtDate) {
          if (!byDate[r.createdAtDate]) {
            byDate[r.createdAtDate] = { total: 0, done: 0 };
          }
          byDate[r.createdAtDate].total++;
          if (r.status === "ได้รับความช่วยเหลือแล้ว") {
            byDate[r.createdAtDate].done++;
          }
        }
      });

      const sortedDates = Object.keys(byDate).sort().reverse().slice(0, 7);

      let dailyRows = "";
      sortedDates.forEach(d => {
        dailyRows += `
          <tr>
            <td>${d}</td>
            <td>${byDate[d].total}</td>
            <td>${byDate[d].done}</td>
          </tr>
        `;
      });

      summaryEl.innerHTML = `
        <div class="row mb-3">
          <div class="col-6 col-md-3">
            <div class="border rounded p-2 text-center">
              <div class="small text-muted">ทั้งหมด</div>
              <div class="fs-5 fw-bold">${total}</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="border rounded p-2 text-center">
              <div class="small text-muted">รอความช่วยเหลือ</div>
              <div class="fs-5 fw-bold text-danger">${pending}</div>
            </div>
          </div>
          <div class="col-6 col-md-3 mt-2 mt-md-0">
            <div class="border rounded p-2 text-center">
              <div class="small text-muted">กำลังช่วย</div>
              <div class="fs-5 fw-bold text-warning">${helping}</div>
            </div>
          </div>
          <div class="col-6 col-md-3 mt-2 mt-md-0">
            <div class="border rounded p-2 text-center">
              <div class="small text-muted">ช่วยแล้ว</div>
              <div class="fs-5 fw-bold text-success">${done}</div>
            </div>
          </div>
        </div>

        <h6 class="fw-bold">วันนี้ (${todayStr})</h6>
        <p class="mb-2">
          เคสใหม่วันนี้: <strong>${todayTotal}</strong> เคส<br/>
          ยังรอ/กำลังช่วย: <strong>${todayPending}</strong> เคส<br/>
          ช่วยเสร็จแล้ววันนี้: <strong>${todayDone}</strong> เคส
        </p>

        <h6 class="fw-bold mt-3">สรุปย้อนหลัง (7 วันล่าสุด)</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered mb-0">
            <thead class="table-light">
              <tr>
                <th>วันที่</th>
                <th>จำนวนเคส</th>
                <th>เคสที่ช่วยเสร็จ</th>
              </tr>
            </thead>
            <tbody>
              ${dailyRows || `<tr><td colspan="3" class="text-muted text-center">ยังไม่มีข้อมูลย้อนหลัง</td></tr>`}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderRequests() {
      const container = document.getElementById("requestsList");
      const filter = document.getElementById("statusFilter").value;
      const myHelperPhone = getMyHelperPhone();

      container.innerHTML = "";

      const filtered = requestsCache.filter(r => {
        if (filter === "pending") return r.status === "รอความช่วยเหลือ";
        if (filter === "helping") return r.status === "มีอาสาช่วยแล้ว";
        if (filter === "done") return r.status === "ได้รับความช่วยเหลือแล้ว";
        return true;
      });

      if (filtered.length === 0) {
        container.innerHTML = "<p class='text-muted'>ยังไม่มีข้อมูล</p>";
        return;
      }

      filtered.forEach((r) => {
        const totalPeople = r.children + r.adults + r.elderly + r.patients;

        const statusBadge =
          r.status === "รอความช่วยเหลือ"
            ? "<span class='badge bg-danger'>รอความช่วยเหลือ</span>"
            : r.status === "มีอาสาช่วยแล้ว"
            ? "<span class='badge bg-warning text-dark'>กำลังให้ความช่วยเหลือ</span>"
            : "<span class='badge bg-success'>ได้รับความช่วยเหลือแล้ว</span>";

        const helperTxt = r.helperName
          ? `ผู้ช่วย: <strong>${r.helperName}</strong> (${r.helperPhone})`
          : "<span class='text-muted'>ยังไม่มีผู้ช่วย</span>";

        const canToggle = (!r.helperPhone || r.helperPhone === myHelperPhone);

        const card = document.createElement("div");
        card.className = "border rounded p-2 mb-2";

        card.innerHTML = `
          <div class="d-flex justify-content-between">
            <div>
              <strong>${statusBadge} พื้นที่: ${r.area}</strong><br/>
              ผู้แจ้ง: ${r.reporterName} | โทร: ${r.phone}<br/>
              ${helperTxt}<br/>
              <small>รวม ${totalPeople} คน</small>
            </div>

            <div class="text-end">
              ${
                r.helperPhone
                  ? ""
                  : `<button class="btn btn-sm btn-outline-success mb-1" onclick="takeRequest('${r.id}')">
                      รับเคสนี้
                    </button><br/>`
              }

              <button class="btn btn-sm btn-outline-primary" onclick="showDetail('${r.id}')">
                รายละเอียด
              </button><br/>

              <button class="btn btn-sm btn-outline-secondary mt-1"
                ${canToggle ? "" : "disabled"}
                onclick="toggleStatus('${r.id}')">
                เปลี่ยนสถานะ
              </button>
            </div>
          </div>
        `;

        container.appendChild(card);
      });
    }

    async function takeRequest(id) {
      const name = prompt("ชื่อผู้ให้ความช่วยเหลือ:");
      if (!name) return;

      const phone = prompt("เบอร์โทร:");
      if (!phone) return;

      const note = prompt("หมายเหตุเพิ่มเติม (ถ้ามี):") || "";

      localStorage.setItem("myHelperPhone", phone);

      await db.collection("requests").doc(id).update({
        helperName: name,
        helperPhone: phone,
        helperNote: note,
        status: "มีอาสาช่วยแล้ว",
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function showDetail(id) {
      const r = requestsCache.find(x => x.id === id);
      if (!r) return;

      const needsText = r.needs && r.needs.length ? r.needs.join(", ") : "-";

      alert(
`สถานะ: ${r.status}
ผู้แจ้ง: ${r.reporterName}
เบอร์ติดต่อ: ${r.phone}
ผู้ช่วย: ${r.helperName || "-"} (${r.helperPhone || "-"})

ที่อยู่: ${r.address}
พื้นที่: ${r.area}
พิกัด: ${r.locationLink || "-"}

รายละเอียด: ${r.detail || "-"}
ความต้องการ: ${needsText}`
      );
    }

    function toggleStatus(id) {
      const r = requestsCache.find(x => x.id === id);
      if (!r) return;

      const myPhone = getMyHelperPhone();

      if (r.helperPhone && r.helperPhone !== myPhone) {
        alert("เฉพาะผู้ที่รับเคสนี้เท่านั้นที่เปลี่ยนสถานะได้");
        return;
      }

      const newStatus =
        r.status === "ได้รับความช่วยเหลือแล้ว"
          ? "รอความช่วยเหลือ"
          : "ได้รับความช่วยเหลือแล้ว";

      db.collection("requests").doc(id).update({
        status: newStatus,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    document.getElementById("helpForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const reporterNameVal = document.getElementById("reporterName").value.trim();
      const phoneVal = document.getElementById("phone").value.trim();
      const areaVal = document.getElementById("area").value.trim();
      const addressVal = document.getElementById("address").value.trim();
      const locationLinkVal = document.getElementById("locationLink").value.trim();
      const childrenVal = parseInt(document.getElementById("children").value || "0");
      const adultsVal = parseInt(document.getElementById("adults").value || "0");
      const elderlyVal = parseInt(document.getElementById("elderly").value || "0");
      const patientsVal = parseInt(document.getElementById("patients").value || "0");
      const petsVal = parseInt(document.getElementById("pets").value || "0");
      const waterLevelVal = document.getElementById("waterLevel").value;
      const detailVal = document.getElementById("detail").value.trim();

      const needs = [];
      if (document.getElementById("needFood").checked) needs.push("อาหารแห้ง/อาหารพร้อมทาน");
      if (document.getElementById("needWater").checked) needs.push("น้ำดื่ม");
      if (document.getElementById("needMedicine").checked) needs.push("ยาและเวชภัณฑ์");
      if (document.getElementById("needBoat").checked) needs.push("เรือ / พาหนะช่วยเหลือ");
      if (document.getElementById("needEvac").checked) needs.push("อพยพออกจากพื้นที่");

      await db.collection("requests").add({
        reporterName: reporterNameVal,
        phone: phoneVal,
        area: areaVal,
        address: addressVal,
        locationLink: locationLinkVal,
        children: childrenVal,
        adults: adultsVal,
        elderly: elderlyVal,
        patients: patientsVal,
        pets: petsVal,
        waterLevel: waterLevelVal,
        needs,
        detail: detailVal,
        helperName: "",
        helperPhone: "",
        helperNote: "",
        status: "รอความช่วยเหลือ",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      alert("ส่งคำขอเรียบร้อยแล้ว ขอบคุณค่ะ");
      e.target.reset();
    });

    document.getElementById("statusFilter").addEventListener("change", function () {
      renderRequests();
    });

    db.collection("requests")
      .orderBy("createdAt", "desc")
      .onSnapshot(snap => {
        requestsCache = snap.docs.map(d => {
          const data = d.data();
          let createdAtDate = "";
          if (data.createdAt && data.createdAt.toDate) {
            createdAtDate = data.createdAt.toDate().toISOString().slice(0, 10);
          }
          return {
            id: d.id,
            ...data,
            createdAtDate
          };
        });
        renderSummary();
        renderRequests();
      });
  </script>

</body>
</html>
